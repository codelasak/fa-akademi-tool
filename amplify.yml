version: 1
frontend:
  phases:
    preBuild:
      commands:
        - echo "Installing pnpm..."
        - npm install -g pnpm@9.0.6
        - echo "Setting up pnpm store..."
        - pnpm config set store-dir .pnpm-store
        - echo "Installing dependencies..."
        - pnpm install --no-frozen-lockfile --prefer-offline
        - echo "Generating Prisma client..."
        - pnpm run prisma:generate
    build:
      commands:
        - echo "Setting up environment for AWS Amplify..."
        - export NODE_ENV=production
        - export NEXT_TELEMETRY_DISABLED=1
        - export SKIP_INSTALL_SIMPLE_GIT_HOOKS=1
        - export CI=true
        - export DISABLE_DB_DURING_BUILD=1
        - echo "Checking critical env vars (presence only) ..."
        - |
          if [ -n "$DATABASE_URL" ]; then echo "DATABASE_URL present"; else echo "DATABASE_URL MISSING"; fi
        - echo "Writing .env.production for build-time inlining (no values printed) ..."
        - |
          printf "DATABASE_URL=%s\nNODE_ENV=production\nNEXT_TELEMETRY_DISABLED=1\n" "$DATABASE_URL" > .env.production
        - echo "Running Next.js build..."
        - pnpm run build
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
      - .pnpm-store/**/*